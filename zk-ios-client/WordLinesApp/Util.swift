//
//  Util.swift
//  ClientApp
//
//  Created by Nalin Bhardwaj on 22/08/21.
//  Copyright Â© 2021 Gnosis. All rights reserved.
//

import Foundation

import Web3
import Web3PromiseKit
import Web3ContractABI

import SwiftyJSON

func getWeb3() -> Web3 {
    return Web3(rpcURL: "https://rinkeby.infura.io/v3/94ab4cf52228436fa729f0c77b91fdf0")
}

func getContractABIString() -> String {
    var request = URLRequest(url: URL(string: "https://gist.githubusercontent.com/nalinbhardwaj/9df7597af77f49a33c76feb333f3b537/raw/6981ed8752eb4fe70fe0d38ba3449f1d379614b8/wordlines.abi")!)
    request.httpMethod = "GET"
    var contractABIString = ""
    let sem = DispatchSemaphore(value: 0)

    URLSession.shared.dataTask(with: request) {data, response, err in
        defer { sem.signal() }
        contractABIString = String(data: data!, encoding: .utf8)!
    }.resume()

    sem.wait()
    
    return contractABIString
}

func getContract(contractAddressString: String) -> DynamicContract {
    let contractJsonABI = getContractABIString().data(using: .utf8)!
    print(contractJsonABI)

    let web3 = getWeb3()

    let contractAddress = try! EthereumAddress(hex: contractAddressString, eip55: true)
    // You can optionally pass an abiKey param if the actual abi is nested and not the top level element of the json
    let contract = try! web3.eth.Contract(json: contractJsonABI, abiKey: "abi", address: contractAddress)
    return contract
}

extension Dictionary {
    func percentEncoded() -> Data? {
        return map { key, value in
            let escapedKey = "\(key)".addingPercentEncoding(withAllowedCharacters: .urlQueryValueAllowed) ?? ""
            let escapedValue = "\(value)".addingPercentEncoding(withAllowedCharacters: .urlQueryValueAllowed) ?? ""
            return escapedKey + "=" + escapedValue
        }
        .joined(separator: "&")
        .data(using: .utf8)
    }
}

extension CharacterSet {
    static let urlQueryValueAllowed: CharacterSet = {
        let generalDelimitersToEncode = ":#[]@" // does not include "?" or "/" due to RFC 3986 - Section 3.4
        let subDelimitersToEncode = "!$&'()*+,;="

        var allowed = CharacterSet.urlQueryAllowed
        allowed.remove(charactersIn: "\(generalDelimitersToEncode)\(subDelimitersToEncode)")
        return allowed
    }()
}

func getProofData(walletAddress: String) -> JSON {
    let walletAddressIntegered = EncodeHex(from: walletAddress)
    
    var request = URLRequest(url: URL(string: "https://wordlines.herokuapp.com/generate_proof")!)
    request.httpMethod = "POST"
    
    let parameters: [String: Any] = [
        "line": [
            "186069883",
            "424222811",
            "78907739",
            "344365947",
            "969831324",
            "969831324",
            "969831324"
        ],
        "figure": "419205722277329093",
        "compressed_dictionary": [
            "124601914772827798340161346426676743022826761098363317008589555678590171",
            "129861353782564462506833897546019714328622532814816348657462538640241922",
            "130185098576996046672820559094285886201834786583637354859447307882019707",
            "134716475867418531822297665822123707805546858221773147956298281369543078",
            "135224133769560944012437567614997574135227986690628787304697128460597905",
            "135208968799621173169132855888194592990837433673064003127188820708467340",
            "135303328613000055833296508023862072910106911989987288478080264917527419",
            "135518534281230768885040319726390489657985367095185163687037297612108242",
            "135693224340698004426575756976549885561654828445398799599763039289215323",
            "140842687694257873580804253721970789258122885755360517695981782101815163",
            "145900272659692044699365278857355117719480037002700227741532347733428689",
            "145925547609750120381524496917520397882743242633251709830996615068076923",
            "290513426716973560603751202359590202838405653372184055206927473446416251",
            "290588479825438249142089629378679467651877808643428832095505210720651611",
            "295484941921053657079990834743509001988565832266675178624547411725858002",
            "295839174623934676534891173153316940587139984942869392525238597978823547",
            "306491776220779920883816573287262516591809274260851471976093031065657819",
            "310916352033618226644961049620133438323916899894000640995255626450246290",
            "311297860620067113080148427543656669462754334075670426544137155876796978",
            "311527020166985495757967973028248306831627638999902798005776019727249275",
            "345798935853453918719222859445982991603013955031144431022792272774640274",
            "354490357647451901712931617379800975849339937995979134919995498815953460",
            "361716330931842277195603217754769735334030441450791800472968673442048603",
            "366744360986034375190304733030998408411325663356086824804875922094780283",
            "459744382098966550963612681814721119734184156514128376253657182270706107",
            "465250214024774007971176661134305393102989315538595766759540504167263099",
            "566068882956780365933687681668763721972410800864732954880332306686843771",
            "566655261797162124069403494570095834927080866058880485538855135956388178",
            "566960720107222118459941022648476546529105454113249335058805470271926139",
            "576758975725540631697079606728014592498650710385595182356826416952693179",
            "577313339629339909243971653037414956495558364960480378926981679650387213",
            "621710545099823935268723517120838153673152841772397047872164479747137958",
            "621876446514891331750508601256365697548305260549284930728802149739360123",
            "631632577224156154206218170900426168163015357913692472300336307152966235",
            "631964521568041554310177252320581946276700189787611448720329423568127579",
            "686878562986569923354630559393318765280896158311420947788680530747617147",
            "687402596950430083450632736437821851839394237483817420011566787987946075",
            "687687361387342402583725649981401383026180207012660257216241560462181819",
            "697198430393688476025253048401242622673258972224682695214952513496240731",
            "697446862089948023888169521274076262964270541787924659328295358727365499",
            "697791812501702271087166237625968775204220559736460655123004552221630538",
            "698061114132245061776233291606451233988898748808100348135923301658737010",
            "732225193322962194207843926162527763694730876914377360867105060778422139",
            "742388619320800828075797963514427551461706534981018981975054506565103483",
            "742955252106464883323415881479719688121941766141538323572143716104236923",
            "787439164148692310476665964079474531632066124407694724995663339071303547",
            "795881945267371725812088582059815919270288024358354850039800423955767387",
            "802945451300825492624853837476667119326090487401962686775672230499634043",
            "962948417115302562172911666454157970333263916455818892015277238403831387",
            "963487616049160297311618037483115566133775573002996570594586569749000059",
            "973501551248772977721954589337515695045905295532453088056136595803622267",
            "973894155472353458055567126097579395899029295171019359546547982244588411",
            "1007780438937991271493782108178278073830394670150970288261621596748461947",
            "1008001157046741873882755376991568095086189256408186027938862304432925275",
            "1008390618356749689849367413904944651730528296894918591307706491166018427",
            "1013266577465282454235573155010740807821308913711141979092156432857368914",
            "1015646687917670595860727839333360545846816467868260779882891487524239730",
            "1018647666981506614227369772949386696526175257982234058915946148185623419",
            "1018701586874899832298089748524769644770657024524111385637956433687918459",
            "1018958917459914368923529560918842102007735157957932358113262219301038683",
            "1028813831099014940731189037217341187136574035507324937305119099749575547",
            "1029286735944968715429486441089813050987288815945570123365723680305072589",
            "1127263472055073681126494625378099229201469867477557897766816280333939612",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700",
            "1595861864961121329946204194219410272360308035887655833142095923748172700"
        ],
        "address": String(walletAddressIntegered),
        "private_address": String(walletAddressIntegered)
    ]
    let jsonData = try? JSONSerialization.data(withJSONObject: parameters)
    request.setValue("\(String(describing: jsonData?.count))", forHTTPHeaderField: "Content-Length")
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    request.httpBody = jsonData
    
    var responseJSON: JSON = []
    let sem = DispatchSemaphore(value: 0)

    URLSession.shared.dataTask(with: request) { data, response, error in
        defer { sem.signal() }
        guard let data = data,
            let response = response as? HTTPURLResponse,
            error == nil else {                                              // check for fundamental networking error
            print("error", error ?? "Unknown error")
            return
        }

        guard (200 ... 299) ~= response.statusCode else {                    // check for http errors
            print("statusCode should be 2xx, but is \(response.statusCode)")
            print("response = \(response)")
            return
        }

        responseJSON = try! JSON(data: data)
        print("responseJSON = \(String(describing: responseJSON))")
    }.resume()

    sem.wait()
    
    return responseJSON
}

public extension String {
  subscript(value: Int) -> Character {
    self[index(at: value)]
  }
    
  var fullyPercentEncodedStr: String {
    self.addingPercentEncoding(withAllowedCharacters: .alphanumerics) ?? ""
  }
}

public extension String {
  subscript(value: NSRange) -> Substring {
    self[value.lowerBound..<value.upperBound]
  }
}

public extension String {
  subscript(value: CountableClosedRange<Int>) -> Substring {
    self[index(at: value.lowerBound)...index(at: value.upperBound)]
  }

  subscript(value: CountableRange<Int>) -> Substring {
    self[index(at: value.lowerBound)..<index(at: value.upperBound)]
  }

  subscript(value: PartialRangeUpTo<Int>) -> Substring {
    self[..<index(at: value.upperBound)]
  }

  subscript(value: PartialRangeThrough<Int>) -> Substring {
    self[...index(at: value.upperBound)]
  }

  subscript(value: PartialRangeFrom<Int>) -> Substring {
    self[index(at: value.lowerBound)...]
  }
}

private extension String {
  func index(at offset: Int) -> String.Index {
    index(startIndex, offsetBy: offset)
  }
}

func EncodeHex(from: String) -> BigUInt {
    return BigUInt(hexString: String(from[2...]))!
}
